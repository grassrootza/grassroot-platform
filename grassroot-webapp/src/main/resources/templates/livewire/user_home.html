<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      data-layout-decorate="~{layout}">
<head>
  <meta charset="UTF-8" />
  <title>LiveWire</title>

  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<body>

<section layout:fragment="header" class="top-container">
  <div class="container">
    <div class="row">
      <div class="col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 col-xs-12">
        <h2 class="text-center header-content-title">LiveWire</h2>
        <h4 class="text-center header-content-subtitle">Home</h4>
      </div>
    </div>
  </div>
</section>

<main layout:fragment="content">

  <section class="group-buttons">
    <div class="container">
      <div class="row">
        <div class="col-md-4 col-md-offset-2 text-center">
          <a href="" th:href="@{alert/list(onlyUnreviewed=false)}">
            <button class="white-button group-button">
              <i class="fa fa-comments-o" aria-hidden="true"></i>View all alerts
            </button>
          </a>
        </div>
        <div class="col-md-4 text-center">
          <a th:href="@{contacts}">
            <button class="white-button group-button">
              Find LiveWire contacts
            </button>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- recycling group members class here -->
  <!-- todo: add polling / refresh -->
  <section class="group-members">
    <div class="row group-members-list">
      <div class="col-md-8 col-md-offset-2">
        <div class="panel-group">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a data-toggle="collapse" href="#collapse2">
                  Latest LiveWire alerts
                  <i class="fa fa-caret-up" aria-hidden="true"></i>
                </a>
              </h4>
            </div>
            <div id="collapse2" class="panel-collapse collapse in">
              <table id="card-table" class="table group-members-table">
                <thead>
                <tr>
                  <th class="col-md-3">Description</th>
                  <th class="col-md-3">Contact name</th>
                  <th class="col-md-2">Number</th>
                  <th class="col-md-2">Tags</th>
                  <th class="col-md-2"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="alert, idx : ${alerts}">
                  <td class="col-md-3">
                    <span th:text="${alert.description}">Description</span>
                  </td>
                  <td class="col-md-3"><span th:text="${alert.contactNameNullSafe}">Contact name</span></td>
                  <td class="col-md-2"><span th:text="${alert.contactNumberFormatted}">Contact number</span></td>
                  <td class="col-md-2"><span th:text="${#strings.listJoin(alert.tagList, ',')}">Tags</span></td>
                  <td class="col-md-2 text-center">
                    <button class="default-button btn-sm"
                            th:onclick="'javascript:fetchAlertDescription(\'' + ${alert.uid} + '\')'"
                            th:attr="data-alertUid=${alert.uid}, data-alertIndex=${idx.index}">
                      Details
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="modal fade" id="viewAlertModal" tabindex="-1" role="dialog" aria-labelledby="viewAlertModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="editNameModal">Alert Details</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <p class="no-vertical">
              <label for="group_description" class="grassroot-lead">Group description:</label>
              <span id="group_description" class="grassroot-body"></span>
            </p>
            <p class="no-vertical">
              <label for="alert_description" class="grassroot-lead">Alert description:</label>
              <span id="alert_description" class="grassroot-body"></span>
            </p>
            <p class="no-vertical">
              <label for="contact_details" class="grassroot-lead">Contact details:</label>
              <span id="contact_details" class="grassroot-body"></span>
            </p>
            <p class="no-vertical">
              <label id="mtg_details_label" for="meeting_details" class="control-label">Meeting details:</label>
              <span id="meeting_details" class="grassroot-body"></span>
            </p>
            <p class="no-vertical">
              <label for="tag_list" class="grassroot-lead">Tags:</label>
              <span th:unless="${canTag}" id="tag_list" class="grassroot-body"></span>
              <form th:if="${canTag}" th:action="@{/livewire/user/alert/tag}" method="post">
                <input type="hidden" id="alert_uid_tag" name="alertUid" />
                <input th:if="${canTag}" name="tags" id="tag_list" type="text" class="input-lg" />
                <button type="submit" class="white-button">Change</button>
              </form>
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-lg default-button btn-neutral" data-dismiss="modal">Close</button>
          <form id="release_form" th:if="${canRelease}" th:action="@{/livewire/user/alert/release}" method="post">
            <input type="hidden" id="alert_uid_release" name="alertUid" />
            <input type="hidden" name="tags" id="release_tags_submit" />
            <button type="submit" class="btn btn-warning btn-lg default-button">Release</button>
          </form>
        </div>
      </div>
    </div>
  </div>

</main>

<div layout:fragment="script-container">

  <script th:src="@{/js/lib/jquery-ui.min.js}"></script>
  <script th:src="@{/js/lib/moment.min.js}"></script>

  <script>

    var group = $("#group_description");
    var desc = $("#alert_description");
    var contact = $("#contact_details");
    var mtgLabel = $("#mtg_details_label");
    var mtgText = $("#meeting_details");
    var tagField = $("#tag_list");
    var tagUid = $("#alert_uid_tag");
    var releaseUid = $("#alert_uid_release");
    var releaseForm = $("#release_form");

    function fetchAlertDescription(alertUid) {
        console.log("fetching alert description, for uid: " + alertUid);
        $.getJSON("/livewire/user/alert/details", {
            alertUid: alertUid
        }, function( data ) {
            console.log("object returned: " + JSON.stringify(data));
           showAlertModal(data);
        });
    }

    function showAlertModal(data) {
        var modal = $("#viewAlertModal");
        desc.text(data.description);
        contact.text(data.contactUserName + ', ' + data.contactUserPhone);
        group.text(data.groupName + '(' + data.groupSize + ' members, ' + data.groupTasks + ')');
        if (data.type === 'INSTANT') {
            mtgLabel.hide();
            mtgText.hide();
        } else {
            mtgLabel.show();
            mtgText.show();
            var m = moment(data.meetingTimeMillis);
            mtgText.text('Meeting about ' + data.meetingName + ', at ' + data.meetingLocation +
              m.format('MMMM Do YYYY, h:mm:ss a'));
        }
        if (releaseForm !== null) {
            releaseForm.toggle(!data.reviewed);
        }
        tagUid.val(data.uid);
        releaseUid.val(data.uid);
        modal.modal();
    }

    $(document).ready(function() {
        var token = $("meta[name='_csrf']");
        var header = $("meta[name='_csrf_header']");
        grassrootJS.setUpAjax(token, header);
    })

  </script>

</div>

</body>
</html>